<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COW & GORILA | Mobile Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;400;600;900&display=swap');
        
        :root { --accent: #10b981; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #020617; 
            color: #f8fafc; 
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        /* Fondo Animado */
        .bg-vibe {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: #020617; overflow: hidden;
        }
        .blob {
            position: absolute; width: 300px; height: 300px;
            background: rgba(16, 185, 129, 0.15); filter: blur(60px);
            border-radius: 50%; animation: float 15s infinite alternate;
        }
        @keyframes float { from { transform: translate(-10%, -10%); } to { transform: translate(80%, 80%); } }

        /* Apple Liquid Glass Responsivo */
        .liquid-glass {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.4);
        }

        .liquid-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.5rem;
            transition: transform 0.2s ease;
        }
        .liquid-card:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.1); }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        input::-webkit-inner-spin-button { -webkit-appearance: none; }
        
        /* Ajuste para Notch de iPhone */
        header { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="antialiased select-none">

    <div class="bg-vibe">
        <div class="blob" style="top: 10%; left: 10%;"></div>
        <div class="blob" style="bottom: 10%; right: 10%; background: rgba(59, 130, 246, 0.1); animation-delay: -3s;"></div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-sm liquid-glass rounded-[2.5rem] p-8 text-center border-emerald-500/10 shadow-2xl">
            <div class="mb-6">
                <div class="w-16 h-16 bg-emerald-500/10 rounded-2xl mx-auto mb-4 flex items-center justify-center border border-emerald-500/20">
                    <i data-feather="target" class="text-emerald-500 w-8 h-8"></i>
                </div>
                <h1 class="font-orbitron text-xl font-black text-white tracking-widest uppercase">COW & GORILA</h1>
                <p class="text-slate-500 text-[9px] uppercase tracking-[0.3em] font-bold">Mobile Node access</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-6 max-h-72 overflow-y-auto pr-1" id="userGrid"></div>

            <div id="pinSection" class="hidden animate-in fade-in zoom-in-95 duration-300">
                <div class="flex justify-center gap-3 mb-6">
                    <input type="password" maxlength="1" class="pin-input w-12 h-14 bg-white/5 border border-white/10 rounded-xl text-center text-3xl text-white outline-none focus:border-emerald-500" data-index="0">
                    <input type="password" maxlength="1" class="pin-input w-12 h-14 bg-white/5 border border-white/10 rounded-xl text-center text-3xl text-white outline-none focus:border-emerald-500" data-index="1">
                    <input type="password" maxlength="1" class="pin-input w-12 h-14 bg-white/5 border border-white/10 rounded-xl text-center text-3xl text-white outline-none focus:border-emerald-500" data-index="2">
                    <input type="password" maxlength="1" class="pin-input w-12 h-14 bg-white/5 border border-white/10 rounded-xl text-center text-3xl text-white outline-none focus:border-emerald-500" data-index="3">
                </div>
                <button id="loginBtn" class="w-full bg-emerald-600 h-14 rounded-2xl font-black tracking-widest text-sm">IDENTIFICAR</button>
            </div>
        </div>
    </div>

    <div id="appContainer" class="hidden min-h-screen flex flex-col">
        <header class="px-6 py-4 sticky top-0 z-40 liquid-glass border-b border-white/5">
            <div class="max-w-xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div id="uAvatar" class="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center font-black text-emerald-400 text-xs border border-emerald-500/20">?</div>
                    <div>
                        <h2 id="uName" class="text-[10px] font-black uppercase tracking-widest text-white leading-none">---</h2>
                        <span class="text-[8px] text-emerald-500 font-bold uppercase tracking-widest">Active</span>
                    </div>
                </div>
                <button onclick="location.reload()" class="w-10 h-10 flex items-center justify-center liquid-card rounded-xl text-slate-400"><i data-feather="power" class="w-4 h-4"></i></button>
            </div>
        </header>

        <main class="flex-1 max-w-xl mx-auto w-full p-4 space-y-4">
            
            <div class="liquid-glass p-4 rounded-2xl flex justify-between items-center">
                <div class="text-[10px] font-black text-slate-500 uppercase">Binance: <span class="text-white italic ml-1">1$ = <span id="tDisplay">0</span> Bs</span></div>
                <button id="admTasa" onclick="openModal('tasaModal')" class="hidden text-emerald-500 p-1"><i data-feather="edit" class="w-4 h-4"></i></button>
            </div>

            <div class="liquid-glass rounded-[2.5rem] py-10 px-6 text-center border-white/5 shadow-inner">
                <span class="text-slate-500 font-bold uppercase text-[9px] tracking-[0.4em]">Node Supply</span>
                <div class="text-7xl font-orbitron font-black text-white my-2"><span id="sVal">0</span><span class="text-xl text-slate-600">g</span></div>
                <div class="h-1 bg-white/5 rounded-full overflow-hidden w-3/4 mx-auto">
                    <div id="sBar" class="h-full bg-emerald-500 shadow-[0_0_15px_#10b981]" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="openModal('buyModal')" class="liquid-card h-32 flex flex-col items-center justify-center gap-2">
                    <i data-feather="shopping-cart" class="text-emerald-500"></i>
                    <span class="text-[10px] font-black uppercase text-white tracking-widest">Compra</span>
                </button>
                <button onclick="openModal('payModal')" class="liquid-card h-32 flex flex-col items-center justify-center gap-2">
                    <i data-feather="send" class="text-emerald-500"></i>
                    <span class="text-[10px] font-black uppercase text-white tracking-widest">Pago</span>
                </button>
                <button id="admUsers" onclick="showSection('sec-users')" class="hidden liquid-card h-20 flex items-center justify-center gap-3 border-blue-500/20">
                    <i data-feather="users" class="w-4 h-4 text-blue-500"></i>
                    <span class="text-[9px] font-black uppercase text-white">Usuarios</span>
                </button>
                <button id="admReset" onclick="resetStock()" class="hidden liquid-card h-20 flex items-center justify-center gap-3 border-red-500/20">
                    <i data-feather="refresh-ccw" class="w-4 h-4 text-red-500"></i>
                    <span class="text-[9px] font-black uppercase text-white">Reset</span>
                </button>
            </div>

            <div id="sec-balances" class="liquid-glass rounded-[2rem] p-6">
                <h3 class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-4 text-center">Protocolo G11</h3>
                <div id="bGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>

            <div id="logList" class="space-y-2"></div>

            <section id="sec-users" class="hidden space-y-4">
                <button onclick="showSection('sec-dash')" class="text-[9px] font-black text-slate-500 uppercase p-2"><i data-feather="chevron-left" class="inline w-3 h-3"></i> Volver</button>
                <div class="liquid-glass rounded-3xl p-6">
                    <form id="fAddU" class="flex gap-2 mb-6">
                        <input type="text" id="nUName" placeholder="NOMBRE" required class="flex-1 bg-white/5 border border-white/10 p-3 rounded-xl text-xs outline-none uppercase font-bold text-white">
                        <button type="submit" class="bg-emerald-600 px-4 rounded-xl font-bold text-[10px]">OK</button>
                    </form>
                    <div id="uListTable" class="space-y-2"></div>
                </div>
            </section>
        </main>
    </div>

    <div id="buyModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="liquid-glass p-8 rounded-[2rem] w-full border-white/20 animate-in zoom-in-95">
            <h3 class="font-orbitron text-white text-center mb-6 text-sm uppercase">Nueva Carga</h3>
            <form id="fBuy" class="space-y-4">
                <input type="number" id="bAmt" step="0.01" required placeholder="TOTAL ($)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none focus:border-emerald-500">
                <input type="number" id="bQty" required placeholder="GRAMOS (g)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none focus:border-emerald-500">
                <select id="bUser" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none"></select>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('buyModal')" class="flex-1 font-bold text-slate-500 text-xs">CERRAR</button>
                    <button type="submit" id="btnBuySync" class="flex-1 bg-emerald-600 py-3 rounded-xl font-black text-xs">ENVIAR</button>
                </div>
            </form>
        </div>
    </div>

    <div id="payModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="liquid-glass p-8 rounded-[2rem] w-full border-white/20 animate-in zoom-in-95">
            <h3 class="font-orbitron text-white text-center mb-6 text-sm uppercase font-bold">Reportar Pago</h3>
            <form id="fPay" class="space-y-4">
                <select id="pTo" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none" required></select>
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="pBs" step="0.01" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none focus:border-emerald-500" placeholder="Bs">
                    <input type="number" id="pUsd" step="0.01" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-white outline-none focus:border-emerald-500" placeholder="$">
                </div>
                <div class="p-5 bg-emerald-500/10 rounded-2xl text-center border border-emerald-500/20">
                    <span class="text-[8px] font-black text-slate-400 uppercase italic">Se abonarán:</span>
                    <div class="text-2xl font-black text-emerald-400 font-orbitron">$ <span id="pPrev">0.00</span></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('payModal')" class="flex-1 font-bold text-slate-500 text-xs">ATRÁS</button>
                    <button type="submit" id="btnPaySync" class="flex-1 bg-emerald-600 py-3 rounded-xl font-black text-xs">LISTO</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tasaModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="liquid-glass p-8 rounded-3xl w-full max-w-xs text-center border-white/20">
            <h3 class="text-xs font-black uppercase text-white mb-4">Nueva Tasa Bs</h3>
            <input type="number" id="nTasa" step="0.1" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-center text-white mb-4 outline-none" placeholder="54.5">
            <div class="flex gap-2">
                <button onclick="closeModal('tasaModal')" class="flex-1 text-slate-500 text-[10px] font-bold">CERRAR</button>
                <button onclick="saveTasa()" class="flex-1 bg-emerald-600 py-2 rounded-lg font-black text-[10px]">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDJzAC79Jf30NmRwnvGBFgC14-YuJJipQY",
            authDomain: "cow-and-gorila.firebaseapp.com",
            projectId: "cow-and-gorila",
            storageBucket: "cow-and-gorila.firebasestorage.app",
            messagingSenderId: "1065551547419",
            appId: "1:1065551547419:web:577fb0dae7adb0caaafcbe"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const G11_MOBILE = ["LS", "Alchaplast", "Luismi", "Delver", "Fadi", "Chadi", "Luis David", "Edson", "Lou", "Pitufin", "Admin"];
        let state = { users: [], inventory: { current: 0 }, transactions: [], tasa: 54.5, currentUser: null };
        let loginSelection = null;

        async function init() {
            const docRef = doc(db, "valkyron_v7", "global_state");
            const snap = await getDoc(docRef);

            if (!snap.exists()) {
                const initU = G11_MOBILE.map((name, i) => ({ 
                    id: Date.now() + i, name, pin: "4200", balance: 0, isAdmin: name === "LS" 
                }));
                await setDoc(docRef, { users: initU, inventory: { current: 0 }, transactions: [], tasa: 54.5 });
            }

            onSnapshot(docRef, (d) => {
                if (d.exists()) {
                    const data = d.data();
                    state.users = data.users;
                    state.inventory = data.inventory;
                    state.transactions = data.transactions;
                    state.tasa = data.tasa || 54.5;
                    render();
                    if(!state.currentUser) setupLogin();
                }
            });

            setupPayCalc();
            feather.replace();
        }

        function setupLogin() {
            const grid = document.getElementById('userGrid');
            grid.innerHTML = state.users.map(u => `
                <button class="liquid-card p-4 rounded-2xl text-[9px] font-black uppercase tracking-widest text-slate-400">
                    ${u.name}
                </button>
            `).join('');
            
            grid.querySelectorAll('button').forEach((btn, i) => {
                btn.onclick = () => {
                    loginSelection = state.users[i];
                    document.getElementById('pinSection').classList.remove('hidden');
                    document.querySelectorAll('.pin-input')[0].focus();
                };
            });
        }

        function render() {
            const s = state.inventory.current || 0;
            document.getElementById('sVal').innerText = s;
            document.getElementById('sBar').style.width = Math.min(100, (s / 200 * 100)) + "%";
            document.getElementById('tDisplay').innerText = state.tasa.toFixed(2);

            if (state.currentUser) {
                document.getElementById('uName').innerText = state.currentUser.name;
                document.getElementById('uAvatar').innerText = state.currentUser.name.substring(0,2).toUpperCase();
                if (state.currentUser.isAdmin) {
                    document.getElementById('admTasa').classList.remove('hidden');
                    document.getElementById('admUsers').classList.remove('hidden');
                    document.getElementById('admReset').classList.remove('hidden');
                }
            }

            const bGrid = document.getElementById('bGrid');
            bGrid.innerHTML = state.users.map(u => `
                <div class="liquid-card p-3 text-center border ${u.id===state.currentUser?.id?'border-emerald-500/40':'border-white/5'}">
                    <div class="text-[7px] text-slate-500 font-black uppercase mb-1">${u.name}</div>
                    <div class="text-[10px] font-black ${u.balance >= 0 ? 'text-emerald-400' : 'text-red-400'}">
                        $${u.balance.toFixed(2)}
                    </div>
                </div>
            `).join('');

            const opts = state.users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            document.getElementById('bUser').innerHTML = opts;
            document.getElementById('pTo').innerHTML = `<option value="">Para...</option>` + opts;

            if(state.currentUser?.isAdmin) {
                document.getElementById('uListTable').innerHTML = state.users.map(u => `
                    <div class="flex justify-between items-center p-3 liquid-glass rounded-xl mb-2">
                        <span class="text-[10px] font-black uppercase text-white">${u.name}</span>
                        ${u.name !== 'LS' ? `<button onclick="deleteUser(${u.id})" class="text-red-500 p-1"><i data-feather="x-circle" class="w-4 h-4"></i></button>` : '<span class="text-[7px] text-emerald-500 font-bold uppercase italic">Root</span>'}
                    </div>
                `).join('');
                feather.replace();
            }

            document.getElementById('logList').innerHTML = state.transactions.slice(-4).reverse().map(t => `
                <div class="p-3 liquid-glass rounded-2xl flex justify-between items-center mb-1 animate-in slide-in-from-bottom-2">
                    <div class="flex flex-col">
                        <span class="text-[7px] font-black text-emerald-500 uppercase">${t.tipo} | ${t.time}</span>
                        <span class="text-[9px] text-slate-400"><b>${t.user}</b> ${t.desc}</span>
                    </div>
                    <span class="font-orbitron text-white text-[10px] font-black">$${t.amt.toFixed(2)}</span>
                </div>
            `).join('');
        }

        window.showSection = (id) => {
            document.getElementById('sec-dash').classList.toggle('hidden', id !== 'sec-dash');
            document.getElementById('sec-balances').classList.toggle('hidden', id !== 'sec-dash');
            document.getElementById('sec-users').classList.toggle('hidden', id !== 'sec-users');
            feather.replace();
        };

        function setupPayCalc() {
            const bs = document.getElementById('pBs'); const usd = document.getElementById('pUsd');
            const calc = () => {
                const tot = (parseFloat(bs.value || 0) / state.tasa) + parseFloat(usd.value || 0);
                document.getElementById('pPrev').innerText = tot.toFixed(2);
            };
            bs.oninput = calc; usd.oninput = calc;
        }

        const pins = document.querySelectorAll('.pin-input');
        pins.forEach((p, i) => {
            p.oninput = () => { if(p.value && i < 3) pins[i+1].focus(); };
            p.onkeydown = (e) => { if(e.key === 'Backspace' && !p.value && i > 0) pins[i-1].focus(); };
        });

        document.getElementById('loginBtn').onclick = () => {
            const pass = Array.from(pins).map(p => p.value).join('');
            if(loginSelection && (pass === loginSelection.pin || pass === "4200")) {
                state.currentUser = loginSelection;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                render();
            } else {
                alert("DENIED"); pins.forEach(p => p.value = "");
            }
        };

        async function sync() {
            await updateDoc(doc(db, "valkyron_v7", "global_state"), {
                users: state.users, inventory: state.inventory, transactions: state.transactions, tasa: state.tasa
            });
        }

        document.getElementById('fBuy').onsubmit = async (e) => {
            e.preventDefault();
            const amt = parseFloat(document.getElementById('bAmt').value);
            const qty = parseInt(document.getElementById('bQty').value);
            const id = parseInt(document.getElementById('bUser').value);
            const share = amt / state.users.length;
            state.users.forEach(u => u.id === id ? u.balance += (amt - share) : u.balance -= share);
            state.inventory.current += qty;
            state.transactions.push({ tipo: 'COMPRA', amt, user: state.users.find(u=>u.id===id).name, desc: 'reposición', time: new Date().toLocaleTimeString() });
            await sync();
            closeModal('buyModal');
            e.target.reset();
        };

        document.getElementById('fPay').onsubmit = async (e) => {
            e.preventDefault();
            const total = parseFloat(document.getElementById('pPrev').innerText);
            const toId = parseInt(document.getElementById('pTo').value);
            if(total <= 0 || isNaN(toId)) return;
            const payer = state.users.find(u => u.id === state.currentUser.id);
            const receiver = state.users.find(u => u.id === toId);
            payer.balance += total; receiver.balance -= total;
            state.transactions.push({ tipo: 'PAGO', amt: total, user: payer.name, desc: `pagó a ${receiver.name}`, time: new Date().toLocaleTimeString() });
            await sync();
            closeModal('payModal');
            e.target.reset();
        };

        window.saveTasa = async () => {
            const val = parseFloat(document.getElementById('nTasa').value);
            if(val > 0) {
                state.tasa = val; await sync(); closeModal('tasaModal');
            }
        };

        document.getElementById('fAddU').onsubmit = async (e) => {
            e.preventDefault();
            const n = document.getElementById('nUName').value;
            state.users.push({ id: Date.now(), name: n, pin: "4200", balance: 0, isAdmin: false });
            await sync(); e.target.reset();
        };

        window.deleteUser = async (id) => {
            if(confirm("Eliminar?")) { state.users = state.users.filter(u => u.id !== id); await sync(); }
        };

        window.resetStock = async () => {
            if(confirm("Reset stock?")) { state.inventory.current = 0; await sync(); }
        };

        window.openModal = (id) => { document.getElementById(id).classList.remove('hidden'); feather.replace(); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        init();
    </script>
</body>
</html>
</html>